<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{screen/customer/header :: html-head}">
</head>

<style>
    :root {
        --primary-color: #FF5722;
        --bg-light: #f5f5f5;
        --border-color: #e8e8e8;
        --text-heading: #333;
        --text-body: #555;
    }

    body { background-color: var(--bg-light); font-family: 'Inter', sans-serif; }

    /* === 1. SIDEBAR BỘ LỌC ACCORDION === */
    .filter-sidebar {
        background: #fff;
        border-radius: 4px;
        box-shadow: 0 1px 1px 0 rgba(0,0,0,.05);
    }

    .filter-header-main {
        padding: 16px;
        font-weight: 800;
        font-size: 1.1rem;
        display: flex; align-items: center; gap: 10px;
        border-bottom: 1px solid var(--border-color);
    }

    /* Accordion Item Styling */
    .filter-group { border-bottom: 1px solid var(--border-color); }
    .filter-group:last-child { border-bottom: none; }

    .filter-group-btn {
        width: 100%;
        background: none;
        border: none;
        padding: 16px;
        text-align: left;
        font-weight: 600;
        color: var(--text-heading);
        display: flex; justify-content: space-between; align-items: center;
        transition: background 0.2s;
    }
    .filter-group-btn:hover { background-color: #fafafa; }

    /* Icon xoay khi đóng mở */
    .filter-group-btn::after {
        content: '\F282'; /* Bootstrap icon chevron-down */
        font-family: 'bootstrap-icons';
        font-size: 12px;
        transition: transform 0.3s;
    }
    .filter-group-btn.collapsed::after { transform: rotate(-90deg); }

    .filter-group-body {
        padding: 0 16px 16px 16px;
        font-size: 14px;
        color: var(--text-body);
    }

    /* Custom Checkbox & Radio Colors */
    .form-check-input:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
    .form-check-input:focus { box-shadow: 0 0 0 0.25rem rgba(255, 87, 34, 0.25); border-color: var(--primary-color); }

    /* === 2. LOADING OVERLAY (Hiệu ứng AJAX) === */
    .product-list-wrapper { position: relative; min-height: 300px; }

    .loading-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255, 255, 255, 0.7);
        z-index: 10;
        display: none; justify-content: center; padding-top: 100px;
        backdrop-filter: blur(1px);
    }
    .loading-overlay.active { display: flex; }

    /* === 3. SORT BAR === */
    .sort-bar-custom {
        background: #ededed; padding: 10px 20px; border-radius: 4px;
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 15px;
    }
    .btn-sort-custom {
        background: #fff; border: 1px solid rgba(0,0,0,.09);
        color: #333; padding: 5px 15px; font-size: 14px;
        margin-right: 5px; border-radius: 2px; text-decoration: none;
    }
    .btn-sort-custom:hover { background: #fdfdfd; color: #333; }
    .btn-sort-custom.active {
        background: var(--primary-color); color: #fff; border-color: var(--primary-color);
    }

    /* === 4. RESPONSIVE === */
    .mobile-filter-btn { display: none; }
    @media (max-width: 992px) {
        .desktop-filter-col { display: none; }
        .mobile-filter-btn { display: block; width: 100%; margin-bottom: 15px; }
    }

    /* =================================
       CHAT BOX STYLES (GIỮ NGUYÊN TỪ FILE 1)
    ================================= */
    .chat-launcher {
        position: fixed; bottom: 20px; right: 20px; height: 60px; width: 60px;
        background: linear-gradient(135deg, #FF5722 0%, #FF7043 100%);
        border-radius: 30px; box-shadow: 0 4px 20px rgba(255, 87, 34, 0.4);
        cursor: pointer; z-index: 99999; display: flex; align-items: center;
        overflow: hidden; transition: width 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), transform 0.3s;
    }
    .chat-launcher:hover { width: 190px; }
    .launcher-icon { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .launcher-icon i { font-size: 24px; color: white; }
    .launcher-text { color: white; font-weight: 600; font-size: 15px; white-space: nowrap; opacity: 0; transition: opacity 0.3s ease 0.1s; padding-right: 20px; }
    .chat-launcher:hover .launcher-text { opacity: 1; }
    .chat-launcher.hidden { transform: scale(0) rotate(180deg); pointer-events: none; }

    .chat-window {
        position: fixed; bottom: 90px; right: 20px; width: 350px;
        background: white; border-radius: 15px; box-shadow: 0 5px 30px rgba(0, 0, 0, 0.15);
        z-index: 999999; display: flex; flex-direction: column; overflow: hidden;
        opacity: 0; transform: translateY(20px) scale(0.95); pointer-events: none;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); transform-origin: bottom right;
    }
    .chat-window.active { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
    .chat-header { background: linear-gradient(135deg, #FF5722 0%, #FF7043 100%); color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; font-weight: 600; }
    .close-btn-area { cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; }
    .close-btn-area:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
    .chat-body { height: 400px; overflow-y: auto; padding: 15px; background: #f9f9f9; }
    .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 80%; word-wrap: break-word; animation: fadeIn 0.3s; font-size: 14px; }
    .user-message { background: #FF5722; color: white; margin-left: auto; text-align: right; border-bottom-right-radius: 4px; }
    .bot-message { background: white; color: #333; border: 1px solid #e0e0e0; border-top-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    .chat-input-area { display: flex; padding: 15px; background: white; border-top: 1px solid #eee; }
    .chat-input { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; outline: none; font-size: 14px; background: #f8f9fa; }
    .chat-input:focus { border-color: #FF5722; background: #fff; }
    .chat-send-btn { background: #FF5722; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
    .chat-send-btn:hover { background: #FF7043; transform: scale(1.1); }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<body class="d-flex flex-column min-vh-100 bg-light">
<div th:replace="~{screen/customer/header :: main-header}"></div>

<main class="container my-4">

    <button class="btn btn-primary mobile-filter-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasFilter">
        <i class="bi bi-funnel-fill me-2"></i> Bộ lọc tìm kiếm
    </button>

    <div class="row">
        <div class="col-lg-3 desktop-filter-col">

            <div th:fragment="filter-content" class="filter-sidebar h-100">
                <div class="filter-header-main d-none d-lg-flex">
                    <i class="bi bi-filter-square-fill text-primary"></i> BỘ LỌC TÌM KIẾM
                </div>

                <form id="filterForm" th:action="@{/api/products/list}" method="get">

                    <div class="filter-group">
                        <button type="button" class="filter-group-btn" data-bs-toggle="collapse" data-bs-target="#collapseSearch" aria-expanded="true">
                            Tìm kiếm
                        </button>
                        <div id="collapseSearch" class="collapse show filter-group-body">
                            <div class="input-group">
                                <input type="text" name="keyword" id="keyword" class="form-control" placeholder="Tên sản phẩm..." th:value="${keyword}">
                                <button class="btn btn-primary" type="button" id="btnSearchTrigger"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <button type="button" class="filter-group-btn" data-bs-toggle="collapse" data-bs-target="#collapsePrice" aria-expanded="true">
                            Khoảng giá
                        </button>
                        <div id="collapsePrice" class="collapse show filter-group-body">
                            <div class="d-flex align-items-center gap-1 mb-2">
                                <input type="number" name="price" id="price" class="form-control form-control-sm" placeholder="₫ TỪ" th:value="${price}">
                                <span>-</span>
                                <input type="number" name="maxPrice" id="priceRange" class="form-control form-control-sm" placeholder="₫ ĐẾN">
                            </div>
                            <button type="button" class="btn btn-primary btn-sm w-100 fw-bold" id="btnPriceTrigger">ÁP DỤNG</button>
                        </div>
                    </div>

                    <div class="filter-group">
                        <button type="button" class="filter-group-btn" data-bs-toggle="collapse" data-bs-target="#collapseBrand" aria-expanded="true">
                            Thương hiệu
                        </button>
                        <div id="collapseBrand" class="collapse show filter-group-body" style="max-height: 200px; overflow-y: auto;">
                            <select name="categoryId" id="categoryId" class="form-select">
                                <option value="">-- Tất cả --</option>
                                <th:block th:each="cat : ${categories}">
                                    <option th:value="${cat.id}" th:text="${cat.name}" th:selected="${cat.id == categoryId}"></option>
                                </th:block>
                            </select>
                        </div>
                    </div>

                    <div class="filter-group">
                        <button type="button" class="filter-group-btn" data-bs-toggle="collapse" data-bs-target="#collapseGender" aria-expanded="true">
                            Giới tính
                        </button>
                        <div id="collapseGender" class="collapse show filter-group-body">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="gAll" value="" th:checked="${gender == null or gender == ''}">
                                <label class="form-check-label" for="gAll">Tất cả</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="gMale" value="NAM" th:checked="${gender == 'NAM'}">
                                <label class="form-check-label" for="gMale">Nam</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="gFemale" value="NU" th:checked="${gender == 'NU'}">
                                <label class="form-check-label" for="gFemale">Nữ</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="gUnisex" value="UNISEX" th:checked="${gender == 'UNISEX'}">
                                <label class="form-check-label" for="gUnisex">Unisex</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <button type="button" class="filter-group-btn" data-bs-toggle="collapse" data-bs-target="#collapseRating" aria-expanded="true">
                            Đánh giá
                        </button>
                        <div id="collapseRating" class="collapse show filter-group-body">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="rating" value="" id="rAll" th:checked="${rating == null}">
                                <label class="form-check-label" for="rAll">Tất cả</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="rating" value="4" id="r4" th:checked="${rating == 4.0}">
                                <label class="form-check-label" for="r4">
                                    <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i></span> trở lên
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="p-3 border-top">
                        <a th:href="@{/api/products/list}" class="btn btn-outline-secondary w-100">Xóa tất cả</a>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-9">

            <div class="sort-bar-custom">
                <div class="d-flex align-items-center">
                    <span class="me-3 small text-muted">Sắp xếp theo</span>
                    <a href="#" class="btn-sort-custom sort-btn active" data-sort="newest">Mới nhất</a>
                    <a href="#" class="btn-sort-custom sort-btn" data-sort="bestseller">Bán chạy</a>
                    <a href="#" class="btn-sort-custom sort-btn" data-sort="priceAsc">Giá thấp</a>
                    <a href="#" class="btn-sort-custom sort-btn" data-sort="priceDesc">Giá cao</a>
                </div>
                <select id="pageSizeSelect" class="form-select form-select-sm w-auto border-0">
                    <option value="6" selected>6 / trang</option>
                    <option value="9">9 / trang</option>
                    <option value="12">12 / trang</option>
                </select>
            </div>

            <div class="product-list-wrapper">

                <div id="loadingOverlay" class="loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <div id="product-list-area">
                    <div id="productListContainer">
                        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-3 g-3">
                            <div class="col" th:each="product : ${productPage.content}">
                                <div th:replace="~{fragment/product-card-fragment :: card(product=${product})}"></div>
                            </div>
                        </div>
                        <div th:if="${productPage.content.isEmpty()}" class="text-center py-5">
                            <img src="https://deo.shopeemobile.com/shopee/shopee-pcmall-live-sg/search/a60759ad1dabe909c46a.png" width="100" alt="Empty">
                            <p class="text-muted mt-3">Không tìm thấy sản phẩm phù hợp</p>
                        </div>
                    </div>

                    <nav aria-label="Page navigation" th:if="${productPage != null and productPage.totalPages > 1}" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:classappend="${productPage.first ? 'disabled' : ''}">
                                <a class="page-link" href="#" th:data-page="${productPage.number - 1}">Trước</a>
                            </li>
                            <li class="page-item" th:each="pageNumber : ${#numbers.sequence(0, productPage.totalPages - 1)}"
                                th:classappend="${pageNumber == productPage.number ? 'active' : ''}">
                                <a class="page-link" href="#" th:data-page="${pageNumber}" th:text="${pageNumber + 1}"></a>
                            </li>
                            <li class="page-item" th:classappend="${productPage.last ? 'disabled' : ''}">
                                <a class="page-link" href="#" th:data-page="${productPage.number + 1}">Sau</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasFilter">
    <div class="offcanvas-header bg-light">
        <h5 class="offcanvas-title fw-bold"><i class="bi bi-funnel-fill"></i> Bộ lọc</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
        <div th:replace="~{:: filter-content}"></div>
    </div>
</div>

<div th:replace="~{screen/customer/footer :: main-footer}"></div>

<div id="chatLauncher" class="chat-launcher" onclick="openChat()">
    <div class="launcher-icon"><i class="bi bi-chat-quote-fill"></i></div>
    <span class="launcher-text">Tư vấn viên AI</span>
</div>

<div id="chatWindow" class="chat-window">
    <div class="chat-header">
        <div class="d-flex align-items-center gap-2"><i class="bi bi-robot"></i><span>Tư vấn viên AI</span></div>
        <div class="close-btn-area" onclick="closeChat()"><span style="font-size: 30px; font-weight: 300; line-height: 20px;">&times;</span></div>
    </div>
    <div class="chat-body" id="chatBody">
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">Xin chào! Tôi là trợ lý tư vấn nước hoa. Tôi có thể giúp gì cho bạn?</div>
        </div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" class="chat-input" placeholder="Nhập câu hỏi..." onkeypress="handleKeyPress(event)">
        <button class="chat-send-btn" onclick="sendMessage()"><i class="bi bi-send-fill"></i></button>
    </div>
</div>

<script>
    // ... (Giữ nguyên toàn bộ nội dung script cũ) ...
    // Bạn copy lại phần script ở câu trả lời trước vào đây
    // ...
    // 1. LOGIC CHATBOX
    function openChat() {
        document.getElementById('chatLauncher').classList.add('hidden');
        document.getElementById('chatWindow').classList.add('active');
        setTimeout(() => { document.getElementById('chatInput').focus(); }, 300);
    }
    function closeChat() {
        document.getElementById('chatWindow').classList.remove('active');
        document.getElementById('chatLauncher').classList.remove('hidden');
    }
    function handleKeyPress(event) { if (event.key === 'Enter') sendMessage(); }
    function scrollToBottom() { const m = document.getElementById('chatMessages'); m.scrollTop = m.scrollHeight; }
    function addMessage(text, className) {
        const div = document.getElementById('chatMessages');
        const msg = document.createElement('div'); msg.className = 'message ' + className; msg.innerHTML = text;
        div.appendChild(msg); scrollToBottom();
    }
    function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;
        addMessage(message, 'user-message');
        input.value = '';

        const chatDiv = document.getElementById('chatMessages');
        const typing = document.createElement('div');
        typing.className = 'message bot-message typing-indicator';
        typing.id = 'typingIndicator';
        typing.innerHTML = '<span></span><span></span><span></span>';
        chatDiv.appendChild(typing);
        scrollToBottom();

        fetch('/api/consultant/chat', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({message: message})
        })
            .then(r => r.json())
            .then(d => {
                const ind = document.getElementById('typingIndicator'); if(ind) ind.remove();
                if (d && d.response) addMessage(d.response, 'bot-message');
                else addMessage('Xin lỗi, tôi không hiểu ý bạn.', 'bot-message');
            })
            .catch(e => {
                const ind = document.getElementById('typingIndicator'); if(ind) ind.remove();
                addMessage('Lỗi kết nối.', 'bot-message');
            });
    }

    // 2. LOGIC BỘ LỌC
    document.addEventListener("DOMContentLoaded", function () {
        const pageSizeSelect = document.getElementById("pageSizeSelect");
        const sortButtons = document.querySelectorAll(".sort-btn");
        const productListArea = document.getElementById("product-list-area");
        const loadingOverlay = document.getElementById("loadingOverlay");

        const btnSearchTrigger = document.getElementById("btnSearchTrigger");
        const btnPriceTrigger = document.getElementById("btnPriceTrigger");

        if(btnSearchTrigger) btnSearchTrigger.addEventListener("click", () => loadProducts(0, getCurrentState().size, getCurrentState().sort));
        if(btnPriceTrigger) btnPriceTrigger.addEventListener("click", () => loadProducts(0, getCurrentState().size, getCurrentState().sort));

        const filterInputs = document.querySelectorAll('#filterForm input[type="radio"], #filterForm select');
        filterInputs.forEach(input => {
            input.addEventListener('change', () => {
                loadProducts(0, getCurrentState().size, getCurrentState().sort);
            });
        });

        function formatCurrency(number) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0 }).format(number);
        }

        function loadProducts(page, size, sort) {
            if(loadingOverlay) loadingOverlay.classList.add('active');
            productListArea.style.opacity = '0.5';

            const filterForm = document.getElementById('filterForm');
            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData);

            params.append('page', page);
            params.append('size', size);
            params.append('sort', sort);

            const fetchUrl = `/api/products/list/fragment?${params.toString()}`;
            console.log("Fetching:", fetchUrl);

            fetch(fetchUrl)
                .then(response => {
                    if (!response.ok) throw new Error("Lỗi mạng: " + response.statusText);
                    return response.text();
                })
                .then(html => {
                    productListArea.innerHTML = html;
                    productListArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                })
                .catch(error => console.error("Lỗi tải danh sách sản phẩm:", error))
                .finally(() => {
                    if(loadingOverlay) loadingOverlay.classList.remove('active');
                    productListArea.style.opacity = '1';
                });
        }

        function getCurrentState() {
            const currentSort = document.querySelector(".sort-btn.active")?.dataset.sort || "newest";
            const currentSize = pageSizeSelect ? pageSizeSelect.value : 6;
            return { sort: currentSort, size: currentSize };
        }

        if(pageSizeSelect) {
            pageSizeSelect.addEventListener("change", function () {
                const size = this.value;
                const state = getCurrentState();
                loadProducts(0, size, state.sort);
            });
        }

        sortButtons.forEach(btn => {
            btn.addEventListener("click", function (e) {
                e.preventDefault();
                sortButtons.forEach(b => b.classList.remove("active"));
                this.classList.add("active");
                const sort = this.dataset.sort;
                const state = getCurrentState();
                loadProducts(0, state.size, sort);
            });
        });

        productListArea.addEventListener("click", function(e) {
            const paginationLink = e.target.closest('a.page-link[data-page]');
            if (paginationLink) {
                e.preventDefault();
                if (paginationLink.closest('.page-item.disabled')) return;
                const page = paginationLink.dataset.page;
                const state = getCurrentState();
                loadProducts(page, state.size, state.sort);
            }
        });
    });
</script>
</body>
</html>