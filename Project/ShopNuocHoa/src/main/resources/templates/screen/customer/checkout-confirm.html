<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{screen/customer/header :: html-head}">
</head>

<style>
    body { background-color: #f4f6f8; font-family: 'Inter', sans-serif; }

    /* Card Styles */
    .checkout-card {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #eff2f5;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.03);
        margin-bottom: 20px;
        overflow: hidden;
    }
    .card-header-custom {
        padding: 20px;
        border-bottom: 1px solid #f0f0f0;
        font-weight: 700;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .card-body-custom { padding: 20px; }

    /* Product List Mini */
    .product-mini-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px dashed #eee;
    }
    .product-mini-item:last-child { border-bottom: none; }
    .product-name { font-weight: 500; color: #333; font-size: 0.95rem; }
    .product-meta { font-size: 0.85rem; color: #888; }
    .product-price { font-weight: 600; color: #333; }

    /* Payment Methods Grid */
    .payment-methods-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    .payment-option {
        position: relative;
    }
    .payment-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    .payment-label {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 100%;
        background: #fff;
    }
    /* Icon thanh to√°n */
    .payment-icon {
        width: 30px;
        height: 30px;
        object-fit: contain;
        font-size: 1.5rem; /* N·∫øu d√πng icon font */
        display: flex; align-items: center; justify-content: center;
    }

    /* Tr·∫°ng th√°i Selected */
    .payment-option input[type="radio"]:checked + .payment-label {
        border-color: #0d6efd;
        background-color: #f0f7ff;
        box-shadow: 0 4px 10px rgba(13, 110, 253, 0.15);
    }
    .payment-option input[type="radio"]:checked + .payment-label::after {
        content: '\F26E'; /* Bootstrap Check Icon */
        font-family: 'bootstrap-icons';
        position: absolute;
        top: 10px;
        right: 10px;
        color: #0d6efd;
        font-weight: bold;
    }

    /* Order Summary Sticky */
    .summary-sticky {
        position: sticky;
        top: 100px; /* C√°ch top khi cu·ªôn */
    }

    .total-row {
        display: flex; justify-content: space-between; align-items: center;
        padding-top: 15px; border-top: 2px solid #f0f0f0; margin-top: 10px;
    }
    .total-price { font-size: 1.5rem; font-weight: 800; color: #FF5722; }
</style>

<body class="d-flex flex-column min-vh-100">
<div th:replace="~{screen/customer/header :: main-header}"></div>

<main class="container my-5 flex-grow-1">
<!--    ƒëi·ªÅu h∆∞·ªõng d·∫°ng Breadcrumb-->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/api/home}" class="text-decoration-none text-muted">Trang ch·ªß</a></li>
            <li class="breadcrumb-item"><a th:href="@{/api/cart}" class="text-decoration-none text-muted">Gi·ªè h√†ng</a></li>
            <li class="breadcrumb-item active fw-bold" aria-current="page">X√°c nh·∫≠n & Thanh to√°n</li>
        </ol>
    </nav>
    <!--Th√¥ng b√°o l·ªói-->
    <div th:if="${errorMessage}" class="alert alert-danger shadow-sm border-0 rounded-3 mb-4">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> <span th:text="${errorMessage}"></span>
    </div>

<!--    Ki·ªÉm tra t·ªìn t·∫°i    -->
    <div th:if="${customer != null and cart != null and !cart.items.isEmpty()}" class="row g-4">

        <div class="col-lg-8">

            <div class="checkout-card">
                <div class="card-header-custom text-primary">
                    <i class="bi bi-geo-alt-fill"></i> Th√¥ng tin nh·∫≠n h√†ng
                </div>
                <div class="card-body-custom">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="small text-muted fw-bold mb-1">H·ªç v√† t√™n</label>
                            <div class="form-control bg-light border-0" th:text="${customer.name}"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted fw-bold mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                            <div class="form-control bg-light border-0" th:text="${customer.getPhoneNumber()}"></div>
                        </div>
                        <div class="col-12">
                            <label class="small text-muted fw-bold mb-1">ƒê·ªãa ch·ªâ giao h√†ng <span class="text-danger">*</span></label>

                            <textarea class="form-control" id="addressInput" name="shippingAddress" rows="2"
                                      th:text="${customer.getFullAddress()}"
                                      placeholder="Nh·∫≠p s·ªë nh√†, t√™n ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán..."></textarea>
                        </div>
                        <div class="col-12">
                            <label class="small text-muted fw-bold mb-1">Ghi ch√∫ ƒë∆°n h√†ng</label>
                            <textarea class="form-control" name="note" rows="2"
                                      placeholder="V√≠ d·ª•: Giao gi·ªù h√†nh ch√≠nh, g·ªçi tr∆∞·ªõc khi giao..."></textarea>

                        </div>
                    </div>

                    <!-- C·∫£nh b√°o n·∫øu thi·∫øu th√¥ng tin -->
                    <div th:if="${customer.getPhoneNumber() == null or #strings.isEmpty(customer.getPhoneNumber()) or customer.getFullAddress() == null or #strings.isEmpty(customer.getFullAddress())}"
                         class="alert alert-warning d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Thi·∫øu th√¥ng tin nh·∫≠n h√†ng:</strong>
                            <span th:if="${customer.getPhoneNumber() == null or #strings.isEmpty(customer.getPhoneNumber())}">S·ªë ƒëi·ªán tho·∫°i</span>
                            <span th:if="${(customer.getPhoneNumber() == null or #strings.isEmpty(customer.getPhoneNumber())) and (customer.getFullAddress() == null or #strings.isEmpty(customer.getFullAddress()))}"> v√† </span>
                            <span th:if="${customer.getFullAddress() == null or #strings.isEmpty(customer.getFullAddress())}">ƒê·ªãa ch·ªâ</span>.
                            Vui l√≤ng c·∫≠p nh·∫≠t tr∆∞·ªõc khi ƒë·∫∑t h√†ng.
                        </div>

                        <div>
                            <a th:href="@{/api/profile}" class="btn btn-outline-primary btn-sm">C·∫≠p nh·∫≠t ngay</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="checkout-card">
                <div class="card-header-custom text-warning">
                    <i class="bi bi-truck"></i> Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn
                </div>
                <div class="card-body-custom">
                    <div class="payment-methods-grid">
                        <label class="payment-option">
                            <!--g√°n m·∫∑c ƒë·ªãnh standard-->
                            <input type="radio" name="shippingMethod" value="STANDARD" checked>
                            <div class="payment-label">
                                <div class="payment-icon text-secondary"><i class="bi bi-box-seam"></i></div>
                                <div>
                                    <div class="fw-bold">Ti√™u chu·∫©n</div>
                                    <div class="small text-muted">3-5 ng√†y (30.000‚Ç´)</div>
                                </div>
                            </div>
                        </label>

                        <label class="payment-option">
                            <input type="radio" name="shippingMethod" value="EXPRESS">
                            <div class="payment-label">
                                <div class="payment-icon text-danger"><i class="bi bi-rocket-takeoff"></i></div>
                                <div>
                                    <div class="fw-bold">H·ªèa t·ªëc</div>
                                    <div class="small text-muted">1-2 ng√†y (50.000‚Ç´)</div>
                                </div>
                            </div>
                        </label>

                    </div>
                </div>
            </div>
            <div class="checkout-card">
                <div class="card-header-custom text-success">
                    <i class="bi bi-credit-card-2-front-fill"></i> Ph∆∞∆°ng th·ª©c thanh to√°n
                </div>
                <div class="card-body-custom">
                    <p class="text-muted small mb-3">Vui l√≤ng ch·ªçn 1 trong c√°c ph∆∞∆°ng th·ª©c d∆∞·ªõi ƒë√¢y:</p>

                    <div class="payment-methods-grid">

                        <!--Thanh to√°n cod-->
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="COD" checked>
                            <div class="payment-label">
                                <div class="payment-icon text-success"><i class="bi bi-cash-coin"></i></div>
                                <div>
                                    <div class="fw-bold">Ti·ªÅn m·∫∑t (COD)</div>
                                    <div class="small text-muted">Thanh to√°n khi nh·∫≠n h√†ng</div>
                                </div>
                            </div>
                        </label>

                        <!--Thanh to√°n vnpay-->
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="VNPAY">
                            <div class="payment-label">
                                <div class="payment-icon text-primary"><i class="bi bi-wallet2"></i></div> <div>
                                <div class="fw-bold">VNPAY QR</div>
                                <div class="small text-muted">ATM / Internet Banking</div>
                            </div>
                            </div>
                        </label>

                        <!--Thanh to√°n momo-->
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="MOMO">
                            <div class="payment-label">
                                <div class="payment-icon" style="color: #a50064"><i class="bi bi-qr-code-scan"></i></div>
                                <div>
                                    <div class="fw-bold">V√≠ MoMo</div>
                                    <div class="small text-muted">Qu√©t m√£ QR MoMo</div>
                                </div>
                            </div>
                        </label>

                        <!--Thanh to√°n zalolay-->
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="ZALOPAY">
                            <div class="payment-label">
                                <div class="payment-icon text-info"><i class="bi bi-phone-vibrate"></i></div>
                                <div>
                                    <div class="fw-bold">ZaloPay</div>
                                    <div class="small text-muted">V√≠ ƒëi·ªán t·ª≠ Zalo</div>
                                </div>
                            </div>
                        </label>

                        <!--Thanh to√°n paypal-->
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="PAYPAL">
                            <div class="payment-label">
                                <div class="payment-icon text-primary"><i class="bi bi-paypal"></i></div>
                                <div>
                                    <div class="fw-bold">PayPal</div>
                                    <div class="small text-muted">Visa / MasterCard</div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>


            <a th:href="@{/api/cart}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Quay l·∫°i Gi·ªè h√†ng
            </a>
        </div>

        <div class="col-lg-4">
            <div class="checkout-card summary-sticky">
                <div class="card-header-custom bg-light">
                    <i class="bi bi-receipt-cutoff"></i> ƒê∆°n h√†ng c·ªßa b·∫°n
                </div>
                <div class="card-body-custom">
                    <div class="mb-3" style="max-height: 300px; overflow-y: auto;">
                        <!--Th√¥ng tin s·∫£n ph·∫©m trong gi·ªè h√†ng-->
                        <div th:each="item : ${cart.items}" class="product-mini-item">
                            <div>
                                <div class="product-name" th:text="${item.product.name}">N∆∞·ªõc hoa ABC</div>
                                <div class="product-meta">x <span th:text="${item.quantity}">1</span></div>
                            </div>
                            <div class="product-price"
                                 th:text="${#numbers.formatDecimal(item.getSubTotal(), 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mb-2 text-muted">
                        <!--T·ªïng gi√° tr·ªã gi·ªè h√†ng-->
                        <span>T·∫°m t√≠nh:</span>
                        <span id="subTotalDisplay"
                              th:data-value="${cart.getTotal()}"
                              th:text="${#numbers.formatDecimal(cart.total, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-muted">
                        <!--G√≠a tr·ªã gi·∫£m gi√°-->
                        <span>Gi·∫£m gi√°:</span>
                        <span id="discountDisplay"
                              th:data-value="${discountAmount != null ? discountAmount : 0}"
                              th:text="${discountAmount != null ? '- ' + #numbers.formatDecimal(discountAmount, 0, 'COMMA', 0, 'POINT') + ' ‚Ç´' : '0 ‚Ç´'}"
                              class="text-success fw-bold">
                        </span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-muted">
                        <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                        <span id="shippingFeeDisplay">30.000 ‚Ç´</span>
                    </div>

                    <!--G√≠a tr·ªã t·ªïng -->
                    <div class="total-row">
                        <span class="fw-bold text-dark">T·ªïng thanh to√°n:</span>
                        <span id="finalTotalDisplay"
                              th:text="${finalTotal != null ? #numbers.formatDecimal(finalTotal, 0, 'COMMA', 0, 'POINT') + ' ‚Ç´' : '0 ‚Ç´'}"
                              class="total-price">
                        </span>

                    </div>

                    <hr>

                    <!-- N√∫t ƒë·∫∑t h√†ng: n·∫øu thi·∫øu th√¥ng tin th√¨ chuy·ªÉn th√†nh link/disabled -->
                    <div th:if="${customer.getPhoneNumber() != null and !#strings.isEmpty(customer.getPhoneNumber()) and customer.getFullAddress() != null and !#strings.isEmpty(customer.getFullAddress()) }">
                        <button type="button" id="btn-place-order" class="btn btn-primary w-100 py-3 fs-5 fw-bold shadow-sm"
                                th:data-total="${finalTotal}"
                                th:data-vnpay-url="@{/api/vnpayment/create-payment(amount=${finalTotal})}"
                                th:data-zalopay-url="@{/api/zalopay/create-payment(amount=${finalTotal})}">
                            ƒê·∫∂T H√ÄNG NGAY
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--Ki·ªÉm tra gi·ªè h√†ng c√≥ s·∫£n ph·∫©m hay kh√¥ng-->
    <div th:if="${customer == null or cart == null or cart.items.isEmpty()}" class="text-center py-5">
        <img src="https://cdn-icons-png.flaticon.com/512/2038/2038854.png" alt="Empty Cart" style="width: 150px; opacity: 0.5">
        <h4 class="mt-4 text-muted">Kh√¥ng c√≥ th√¥ng tin ƒë∆°n h√†ng</h4>
        <a th:href="@{/api/products/list}" class="btn btn-primary mt-3 px-4 rounded-pill">Mua s·∫Øm ngay</a>
    </div>


    <!--Form ·∫©n g·ª≠i d·ªØ li·ªáu n·∫øu ch·ªçn COD-->
    <form id="form-cod" th:action="@{/api/checkout/finalize}" method="post" style="display: none;">
        <input type="hidden" name="shippingAddress" id="hidden-address">
        <input type="hidden" name="paymentMethod" id="hidden-payment">
        <input type="hidden" name="shippingMethod" id="hidden-shipping">
        <input type="hidden" name="couponCode" id="hidden-coupon">
        <input type="hidden" name="note" id="hidden-note">
    </form>

    <!--Form ·∫©n g·ª≠i d·ªØ li·ªáu n·∫øu ch·ªçn PAYPAL-->
    <form id="form-paypal" th:action="@{/api/paypal/pay}" method="post" style="display: none;">
        <input type="hidden" name="note" id="paypal-note">
    </form>

</main>

<div th:replace="~{screen/customer/footer :: main-footer}"></div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        <!--kh·ªüi t·∫°o & l·∫•y ph·∫ßn t·ª≠-->
        const btnOrder = document.getElementById("btn-place-order"); //N√∫t ƒë·∫∑t h√†ng
        const addressInput = document.getElementById("addressInput"); //ƒë·ªãa ch·ªâ
        const noteInput = document.querySelector('textarea[name="note"]'); // ghi ch√∫
        const subTotalEl = document.getElementById("subTotalDisplay"); //T·ªïng gi√° tr·ªã gi·ªè h√†ng
        const shippingFeeEl = document.getElementById("shippingFeeDisplay"); //T·ªïng gia ship
        const finalTotalEl = document.getElementById("finalTotalDisplay"); // T·ªïng gia tri cuoi cung
        const discountEl = document.getElementById("discountDisplay"); //G√≠a tr·ªã gi·∫£m gi√°

        const shippingRadios = document.querySelectorAll('input[name="shippingMethod"]'); //Radio ptvc

        let subTotal = parseFloat(subTotalEl?.getAttribute("data-value")) || 0;
        let discount = parseFloat(discountEl?.getAttribute("data-value")) || 0;
        // let shippingFee = 30000; // m·∫∑c ƒë·ªãnh Ti√™u chu·∫©n

        // H√†m Format ti·ªÅn
        const formatCurrency = (amount) => new Intl.NumberFormat("vi-VN").format(amount) + " ‚Ç´";

        // T√≠nh l·∫°i t·ªïng ti·ªÅn
        const recalculateTotal = () => {
            const selectedShipping = document.querySelector('input[name="shippingMethod"]:checked')?.value;
            const address = addressInput.value.trim().toLowerCase();

            let shippingFee = 0;
            if (selectedShipping === "EXPRESS") {
                if (address.includes("qu·∫≠n") || address.includes("tp")) shippingFee = 30000;
                else shippingFee = 50000;
            } else { // STANDARD
                if (address.includes("qu·∫≠n") || address.includes("tp")) shippingFee = 15000;
                else shippingFee = 25000;
            }

            let finalTotal = subTotal + shippingFee - discount;
            if (finalTotal < 0) finalTotal = 0;

            shippingFeeEl.textContent = formatCurrency(shippingFee); // g√°n l·∫°i gi√° tr·ªã
            finalTotalEl.textContent = formatCurrency(finalTotal);
        };


        // L·∫Øng nghe thay ƒë·ªïi ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn(n·∫øu ch·ªçn l·∫°i th√¨ t√≠nh l·∫°i t·ªïng ti·ªÅn)
        shippingRadios.forEach(r => r.addEventListener("change", recalculateTotal));

        // X·ª≠ l√Ω n√∫t ƒë·∫∑t h√†ng
        btnOrder.addEventListener("click", function () {
            const address = addressInput.value.trim();
            const note = noteInput?.value || "";
            // L∆∞u v√†o sessionStorage t·∫°m th·ªùi (client-side)
            sessionStorage.setItem("checkoutNote", note);

            <!--L·∫•y payment (ph∆∞∆°ng th·ª©c thanh to√°n) v√† shipping.-->
            const payment = document.querySelector('input[name="paymentMethod"]:checked')?.value;

            const shipping = document.querySelector('input[name="shippingMethod"]:checked')?.value;

            <!--amount l·∫•y t·ª´ attribute data-total tr√™n n√∫t (th:data-total="${finalTotal}").-->
            const amount = this.getAttribute("data-total");
            const originalText = this.innerHTML; //tr·∫£ v·ªÅ to√†n b·ªô n·ªôi dung HTML b√™n trong ph·∫ßn t·ª≠

            if (!address) {
                alert("‚ö† Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng!");
                addressInput.focus();
                return;
            }

            // G√°n d·ªØ li·ªáu v√†o form COD
            document.getElementById("hidden-note").value = note;
            document.getElementById("hidden-address").value = address;
            document.getElementById("hidden-payment").value = payment;
            document.getElementById("hidden-shipping").value = shipping;
            document.getElementById("hidden-coupon").value = document.querySelector('input[name="couponCode"]')?.value || "";

            // Disable n√∫t + spinner tr√°nh nh·∫•n nhi·ªÅu l·∫ßn
            btnOrder.disabled = true;
            btnOrder.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> ƒêang x·ª≠ l√Ω...`; //gan

            switch(payment) {
                case "COD":
                    <!--submit form #form-cod-->
                    document.getElementById("form-cod").submit();
                    break;

                case "VNPAY":
                    <!--l·∫•y URL t·ª´ data-vnpay-url attribute c·ªßa n√∫t -> n·ªëi th√™m &note=...-->
                    let vnpayUrl = btnOrder.getAttribute("data-vnpay-url");
                    vnpayUrl += `&note=${encodeURIComponent(note)}`;

                    <!--redirect ng∆∞·ªùi d√πng t·ªõi payment gateway.-->
                    window.location.href = vnpayUrl;
                    break;

                case "ZALOPAY":
                    <!--t∆∞∆°ng t·ª± VNPAY (d√πng data-zalopay-url).-->
                    let zalopayUrl = btnOrder.getAttribute("data-zalopay-url");
                    zalopayUrl += `&note=${encodeURIComponent(note)}`;
                    window.location.href = zalopayUrl;
                    break;

                case "PAYPAL":
                    <!--g√°n paypal-note r·ªìi submit #form-paypal.-->
                    document.getElementById("paypal-note").value = noteInput.value;
                    document.getElementById("form-paypal").submit();
                    break;

                case "MOMO":
                    // L∆∞u snapshot v√†o sessionStorage
                    sessionStorage.setItem("checkout_snapshot", JSON.stringify({
                        address,
                        note,
                        payment,
                        shipping,
                        coupon: document.querySelector('input[name="couponCode"]')?.value || ""
                    }));
                    // handleMomoPayment(amount, btnOrder, originalText);
                    const finalAmount = parseFloat(amount) || 0; // convert s·ªë

                    <!--AJAX POST t·ªõi (/api/momo) ƒë·ªÉ server tr·∫£ payUrl-->
                    handleMomoPayment(finalAmount, btnOrder, originalText, note);
                    break;

                default:
                    alert("üí° H√£y ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!");
                    btnOrder.disabled = false;
                    btnOrder.innerHTML = originalText;
            }
        });

        // X·ª≠ l√Ω API MoMo (V√¨ Spring Security y√™u c·∫ßu ƒë·ªÉ ch·∫•p nh·∫≠n POST/DELETE/PATCH request )
        function handleMomoPayment(amount, btn, originalText, note) {
            <!--d√πng Spring Security, framework s·∫Ω t·ª± ƒë·ªông th√™m m·ªôt tr∆∞·ªùng ·∫©n (hidden input) v√†o form khi render-->
            const csrfToken = document.querySelector('input[name="_csrf"]')?.value;

            const headers = { "Content-Type": "application/json" };

            <!--N·∫øu c√≥ CSRF token th√¨ ƒë∆∞a v√†o header chu·∫©n do Spring y√™u c·∫ßu-->
            if (csrfToken) headers["X-CSRF-TOKEN"] = csrfToken;

            <!--G·ª≠i POST JSON t·ªõi /api/momo (t·∫°o giao d·ªãch MoMo v√† tr·∫£ v·ªÅ payUrl).-->
            fetch("/api/momo", {
                method: "POST",
                headers: headers,
                body: JSON.stringify({
                    amount: amount,
                    shippingAddress: addressInput.value.trim(),
                    note: note,
                    shippingMethod: document.querySelector('input[name="shippingMethod"]:checked')?.value || "STANDARD",
                    couponCode: document.querySelector('input[name="couponCode"]')?.value || ""
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.payUrl) {
                        window.location.href = data.payUrl;
                    } else {
                        alert("‚ùå L·ªói MoMo: " + (data.message || "Kh√¥ng x√°c ƒë·ªãnh"));
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                })
                .catch(() => {
                    alert("üö´ Kh√¥ng k·∫øt n·ªëi MoMo!");
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
        }

        recalculateTotal(); // ch·∫°y l·∫ßn ƒë·∫ßu
    });
</script>

</body>
</html>