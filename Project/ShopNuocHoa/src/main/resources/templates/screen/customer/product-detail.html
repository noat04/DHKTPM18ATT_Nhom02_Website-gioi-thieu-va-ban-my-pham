<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head th:replace="~{screen/customer/header :: html-head}"></head>

<body class="d-flex flex-column min-vh-100 bg-light">

<div th:replace="~{screen/customer/header:: main-header}"></div>

<main class="container my-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/static}">Trang chủ</a></li>
            <li class="breadcrumb-item"><a th:href="@{/api/products/list}">Sản phẩm</a></li>
            <li class="breadcrumb-item active" aria-current="page" th:text="${product.name}">Chi tiết sản phẩm</li>
        </ol>
    </nav>

    <div th:if="${product == null}" class="alert alert-warning text-center">
        <h2>Không tìm thấy sản phẩm!</h2>
        <p>Sản phẩm bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
        <a th:href="@{/api/products/list}" class="btn btn-primary mt-2">Quay lại danh sách</a>
    </div>

    <div th:if="${product != null}" class="card shadow-sm">
        <div class="row g-0">
            <div class="col-md-5">
                <!--                <img src="https://via.placeholder.com/500x500" class="img-fluid rounded-start" alt="Product Image">-->
                <img th:src="${product.imageUrl != null && !#strings.isEmpty(product.imageUrl)
                                          ? product.imageUrl
                                          : 'https://via.placeholder.com500x500?text=No+Image'}"
                     class="img-fluid rounded-start"
                     th:alt="${product.name}">
            </div>

            <div class="col-md-7">
                <div class="card-body p-4">
                    <h1 class="card-title" th:text="${product.name}">Tên sản phẩm</h1>
                    <!-- ⭐ Đánh giá và ❤️ Yêu thích -->
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <!-- Đánh giá sao -->
                        <div>
                           <span th:each="i : ${#numbers.sequence(1,5)}"
                                 class="bi fs-5 me-1"
                                 th:classappend="${i <= T(java.lang.Math).round((rating != null ? rating : 0))} ?
                                'bi-star-fill text-warning' : 'bi-star text-secondary'">
                            </span>
                            <small class="text-muted"
                                   th:text="'(' + ${rating} + '/5)'">
                            </small>


                        </div>

                        <!-- Nút yêu thích -->
                        <form th:action="@{/api/wishlist/toggle}" method="post" class="d-inline">
                            <input type="hidden" name="productId" th:value="${product.id}">
                            <button type="submit" class="btn border-0 p-0" style="background: none;">
                                <i class="bi fs-4"
                                   th:classappend="${product.isFavorite} ? 'bi-heart-fill text-danger' : 'bi-heart text-secondary'"></i>
                            </button>
                        </form>
                    </div>


                    <h5 class="card-subtitle mb-3 text-muted" th:text="${product.category.name}">Nhà sản xuất</h5>

                    <p class="card-text fs-2 fw-bold text-danger my-3">
                        <span th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                    </p>

                    <p class="card-text">
                        <strong>Tình trạng:</strong>
                        <span th:if="${product.isInStock()}" class="badge bg-success">
                            Còn hàng
                            (<span th:text="${product.quantity}"></span> sản phẩm)
                        </span>
                        <span th:unless="${product.isInStock()}" class="badge bg-danger">Hết hàng</span>
                    </p>

                    <hr>

                    <p class="card-text">Đây là phần mô tả ngắn cho sản phẩm. Bạn có thể thêm một thuộc tính 'description' vào Entity Product để hiển thị ở đây.</p>

                    <form th:action="@{/api/cart}" method="post" class="mt-4">
                        <input type="hidden" name="action" value="add">
                        <input type="hidden" name="productId" th:value="${product.id}">

                        <div class="d-flex align-items-center">
                            <div th:if="${product.quantity > 0}">
                                <label for="quantity" class="me-2">Số lượng:</label>
                                <input type="number" id="quantity" name="quantity" value="1" min="1"
                                       th:max="${product.quantity}" class="form-control d-inline-block" style="width: 80px;">
                                <button type="submit" class="btn btn-primary btn-lg ms-3">
                                    <i class="bi bi-cart-plus"></i> Thêm vào giỏ hàng
                                </button>
                            </div>
                            <div th:unless="${product.quantity > 0}">
                                <button type="button" class="btn btn-secondary btn-lg" disabled>Đã hết hàng</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mt-5">
        <div class="card-header">
            <h3 class="fw-bold">Cùng thương hiệu</h3>
        </div>
        <div class="card-body">
            <div th:replace="~{fragment/product-list-carousel :: product-list(similarProducts=${similarProducts}, carouselId='similarProductsCarousel')}"></div>
        </div>
    </div>

    <div class="card shadow-sm mt-5 border-0" style="border-radius: 15px;">
        <div class="card-header bg-white border-0 pt-4 pb-0">
            <h3 class="fw-bold"><i class="bi bi-chat-quote-fill me-2"></i>Đánh giá sản phẩm</h3>
        </div>

        <div class="card-body p-4">

            <div sec:authorize="isAuthenticated()">
                <form th:action="@{/api/comments/add}" method="post" class="mb-4 p-4 bg-light rounded-3">
                    <input type="hidden" name="productId" th:value="${product.id}">

                    <div class="mb-3 text-center">
                        <label class="form-label fw-bold d-block mb-2">Bạn cảm thấy sản phẩm thế nào?</label>
                        <div class="rating-input d-flex flex-row-reverse justify-content-center gap-2">
                            <input type="radio" id="star5" name="rating" value="5" required/><label for="star5" title="Tuyệt vời">★</label>
                            <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="Tốt">★</label>
                            <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="Bình thường">★</label>
                            <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="Tệ">★</label>
                            <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="Rất tệ">★</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="commentText" class="form-label fw-bold">Chia sẻ cảm nhận của bạn:</label>
                        <textarea name="text" id="commentText" class="form-control border-0 shadow-sm" rows="4"
                                  placeholder="Hãy chia sẻ những điều bạn thích về sản phẩm này nhé..."
                                  style="resize: none;" required></textarea>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-primary px-4 rounded-pill fw-bold shadow-sm">
                            <i class="bi bi-send-fill me-2"></i>Gửi Đánh Giá
                        </button>
                    </div>
                </form>
            </div>

            <div sec:authorize="!isAuthenticated()" class="text-center py-5 bg-light rounded-3">
                <i class="bi bi-person-lock fs-1 text-secondary mb-3 d-block"></i>
                <h5 class="fw-bold text-dark">Bạn cần đăng nhập để đánh giá</h5>
                <p class="text-muted mb-4">Vui lòng đăng nhập để chia sẻ trải nghiệm của bạn với cộng đồng.</p>
                <a th:href="@{/api/login}" class="btn btn-outline-primary px-4 rounded-pill">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Đăng nhập ngay
                </a>
            </div>

            <div class="mt-4">
                <div th:replace="~{fragment/comment-list-for-detail :: comment-list}"></div>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{screen/customer/footer :: main-footer}"></div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        // --- XỬ LÝ CLICK (Sửa, Hủy, Xóa) ---
        document.body.addEventListener("click", function(e) {

            // 1. Nút SỬA (btn-edit-comment)
            // Dùng .closest() để đảm bảo click vào icon bên trong nút vẫn nhận
            const editBtn = e.target.closest('.btn-edit-comment');
            if (editBtn) {
                e.preventDefault();
                const commentId = editBtn.dataset.commentId;

                console.log("Sửa comment:", commentId);

                // Ẩn nhóm nút Sửa/Xóa
                const actionsDiv = document.getElementById(`comment-actions-${commentId}`);
                if (actionsDiv) actionsDiv.style.display = 'none';

                // Hiện form Sửa
                const editForm = document.getElementById(`comment-edit-form-${commentId}`);
                if (editForm) editForm.style.display = 'block';

                // Focus vào ô textarea để tiện nhập liệu
                const textarea = editForm.querySelector('textarea');
                if(textarea) textarea.focus();
                return;
            }

            // 2. Nút HỦY (btn-cancel-edit)
            const cancelBtn = e.target.closest('.btn-cancel-edit');
            if (cancelBtn) {
                e.preventDefault();
                const commentId = cancelBtn.dataset.commentId;

                console.log("Hủy sửa comment:", commentId);

                // Ẩn form Sửa
                const editForm = document.getElementById(`comment-edit-form-${commentId}`);
                if (editForm) editForm.style.display = 'none';

                // Hiện lại nhóm nút Sửa/Xóa
                const actionsDiv = document.getElementById(`comment-actions-${commentId}`);
                if (actionsDiv) actionsDiv.style.display = 'block';
                return;
            }
        });

        // --- XỬ LÝ SUBMIT FORM (Lưu) ---
        document.body.addEventListener("submit", function(e) {

            // Chỉ xử lý form có class 'form-edit-comment'
            if (e.target.classList.contains('form-edit-comment')) {
                e.preventDefault(); // Ngăn submit mặc định

                const form = e.target;
                const formData = new FormData(form);
                const commentId = formData.get('commentId');
                const newText = formData.get('text');

                // Hiệu ứng loading (tùy chọn)
                const saveBtn = form.querySelector('.btn-save-comment');
                const originalBtnText = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang lưu...';

                // Lấy CSRF Token
                const csrfTokenEl = document.querySelector('form[method="post"] input[name="_csrf"]');
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded',
                };
                if (csrfTokenEl) {
                    headers['X-CSRF-TOKEN'] = csrfTokenEl.value;
                }

                // Gọi API AJAX
                fetch('/api/comments/edit', {
                    method: 'POST',
                    headers: headers,
                    body: new URLSearchParams({
                        commentId: commentId,
                        text: newText
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text || response.status); });
                        }
                        return response.json();
                    })
                    .then(updatedComment => {
                        // Cập nhật giao diện
                        const textElement = document.getElementById(`comment-text-${commentId}`);
                        if (textElement) textElement.textContent = updatedComment.text;

                        // Ẩn form, hiện nút
                        document.getElementById(`comment-edit-form-${commentId}`).style.display = 'none';
                        document.getElementById(`comment-actions-${commentId}`).style.display = 'block';
                    })
                    .catch(error => {
                        console.error("Lỗi:", error);
                        alert("Không thể lưu bình luận: " + error.message);
                    })
                    .finally(() => {
                        // Trả lại trạng thái nút
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalBtnText;
                    });
            }
        });

    });
</script>
</body>
</html>