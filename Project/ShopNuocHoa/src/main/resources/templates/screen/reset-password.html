<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{screen/customer/header :: html-head}"></head>
<style>
    /* ... (CSS cũ giữ nguyên) ... */
    body { background-color: #f0f2f5; }
    .auth-container { min-height: 80vh; display: flex; align-items: center; justify-content: center; padding: 40px 0; }
    .auth-card { background: white; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; width: 100%; max-width: 500px; }
    .auth-form-wrapper { padding: 50px; width: 100%; }

    .btn-auth {
        background: linear-gradient(to right, #667eea, #764ba2);
        border: none; padding: 12px; border-radius: 10px;
        font-weight: 600; color: white; width: 100%;
        transition: 0.3s;
    }
    .btn-auth:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .form-control {
        padding: 12px; border-radius: 10px;
        background: #f9f9f9; border: 1px solid #eee;
    }

    /* --- [THÊM CSS CHO NÚT HIỆN MẬT KHẨU] --- */
    .password-group {
        position: relative;
    }
    .password-group .form-control {
        padding-right: 45px; /* Chừa chỗ cho nút mắt */
    }
    .btn-toggle-password {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        z-index: 10;
    }
    .btn-toggle-password:hover { color: #333; }
</style>

<body class="d-flex flex-column min-vh-100">
<div th:replace="~{screen/customer/header :: main-header}"></div>

<main class="auth-container">
    <div class="auth-card">
        <div class="auth-form-wrapper">

            <div class="text-center mb-4">
                <h3 class="fw-bold">Đặt lại mật khẩu</h3>
                <p class="text-muted small">Mã OTP đã được gửi đến email của bạn.</p>
            </div>

            <div th:if="${errorMessage}" class="alert alert-danger py-2 small rounded-3 text-center">
                <span th:text="${errorMessage}"></span>
            </div>

            <form th:action="@{/api/reset-password}" method="post">

                <input type="hidden" id="server-remaining-time" th:value="${remainingSeconds}" />

                <div class="mb-3">
                    <label class="form-label fw-bold small text-secondary">Mã xác thực (OTP)</label>
                    <input type="text" name="otp" class="form-control text-center fw-bold"
                           placeholder="------" maxlength="6" required autocomplete="off" style="letter-spacing: 5px; font-size: 1.2rem;">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small text-secondary">Mật khẩu mới</label>
                    <div class="password-group">
                        <input type="password" name="newPassword" id="newPassword" class="form-control" placeholder="••••••••" required>
                        <button type="button" class="btn-toggle-password" onclick="togglePassword('newPassword', this)">
                            <i class="bi bi-eye-slash-fill"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold small text-secondary">Xác nhận mật khẩu</label>
                    <div class="password-group">
                        <input type="password" name="confirmPassword" id="confirmPassword" class="form-control" placeholder="••••••••" required>
                        <button type="button" class="btn-toggle-password" onclick="togglePassword('confirmPassword', this)">
                            <i class="bi bi-eye-slash-fill"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" id="btn-confirm" class="btn btn-auth mb-3">Xác nhận đổi mật khẩu</button>

                <div class="text-center mt-3">
                    <p class="small text-muted mb-1">
                        Mã sẽ hết hạn sau:
                        <span id="countdown" class="fw-bold text-danger" style="font-size: 1.1rem;">--:--</span>
                    </p>
                </div>

                <div id="resend-box" class="text-center mt-2" style="display: none;">
                    <p class="small text-muted mb-1">Mã đã hết hạn hoặc bạn chưa nhận được?</p>
                    <a th:href="@{/api/forgot-password}" class="text-primary fw-bold text-decoration-none">
                        <i class="bi bi-arrow-repeat"></i> Gửi lại mã mới
                    </a>
                </div>

            </form>
        </div>
    </div>
</main>

<div th:replace="~{screen/customer/footer :: main-footer}"></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // ... (Logic đếm ngược giữ nguyên như cũ) ...
        const serverTimeInput = document.getElementById('server-remaining-time');
        let timeLeft = serverTimeInput && serverTimeInput.value ? parseInt(serverTimeInput.value) : 0;
        const countdownEl = document.getElementById('countdown');
        const resendBox = document.getElementById('resend-box');
        const btnConfirm = document.getElementById('btn-confirm');

        function updateDisplay() {
            if (timeLeft <= 0) {
                if (typeof timer !== 'undefined') clearInterval(timer);
                countdownEl.innerHTML = "Hết hạn";
                countdownEl.classList.remove("text-danger");
                countdownEl.classList.add("text-secondary");
                resendBox.style.display = "block";
                if(btnConfirm) btnConfirm.disabled = true;
            } else {
                let minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
                minutes = minutes < 10 ? '0' + minutes : minutes;
                seconds = seconds < 10 ? '0' + seconds : seconds;
                countdownEl.innerHTML = `${minutes}:${seconds}`;
            }
        }
        updateDisplay();
        const timer = setInterval(() => {
            if (timeLeft > 0) {
                timeLeft--;
                updateDisplay();
            } else {
                updateDisplay();
            }
        }, 1000);
    });

    // [THÊM MỚI] Hàm xử lý ẩn hiện mật khẩu
    function togglePassword(inputId, btn) {
        const input = document.getElementById(inputId);
        const icon = btn.querySelector('i');

        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove("bi-eye-slash-fill");
            icon.classList.add("bi-eye-fill");
        } else {
            input.type = "password";
            icon.classList.remove("bi-eye-fill");
            icon.classList.add("bi-eye-slash-fill");
        }
    }
</script>

</body>
</html>